name: Frost Test Automation Pipeline

on:
  workflow_dispatch: # Trigger the pipeline manually
    inputs:
      Branch:
        description: "Please enter the branch name"
        default: "main"
        required: true
      Select_Environment:
        description: "Select the Environment which you want to test"
        required: true
        type: choice
        options:
          - "https://frost-dev.health.elsevier.com/"
          - "https://frost-cert.health.elsevier.com/"
          - "https://frost-stage.health.elsevier.com/"
          - "https://frost-prod.health.elsevier.com/"
      Frost_Username:
        description: "Please enter the username"
        required: true
      Frost_Password:
        description: "Please enter the encrypted password"
        required: true
      Select_Browser:
        description: "Select the browser on which you want to run test"
        required: true
        type: choice
        options:
          - "Chrome"
          - "FireFox"
          - "Edge"
          - "Safari"

jobs:
  frost-pipeline:
    runs-on: ubuntu-latest

    env:
      APPLICATION_URL: ${{ inputs.Select_Environment }}
      FROST_USERNAME: ${{ inputs.Frost_Username }}
      FROST_PASSWORD: ${{ inputs.Frost_Password }}
      BROWSER: ${{ inputs.Select_Browser }}

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3
      with:
        ref: ${{ inputs.Branch }}

    - name: Set Up Java
      uses: actions/setup-java@v3
      with:
        java-version: 11
        distribution: adopt

    - name: Install Maven
      run: sudo apt-get install -y maven

    - name: Validate Inputs
      run: |
        echo "::add-mask::${{ env.FROST_PASSWORD }}" # Mask the password in logs
        if [[ "${{ env.FROST_USERNAME }}" =~ ^\\S{2,}$ ]]; then
          echo "Valid username"
        else
          echo "Invalid username: Username should have minimum of 2 characters excluding whitespace"
          exit 1
        fi

        if [[ "${{ env.FROST_PASSWORD }}" =~ ^\\S{2,}$ ]]; then
          echo "Valid password"
        else
          echo "Invalid password: Password should have minimum of 2 characters excluding whitespace"
          exit 1
        fi

    - name: Build Code
      run: mvn compile

    - name: Test Execution
      run: |
        mvn test \
          -Dapplication.url=${{ env.APPLICATION_URL }} \
          -Dusername=${{ env.FROST_USERNAME }} \
          -Dpassword=${{ env.FROST_PASSWORD }} \
          -Dbrowser=${{ env.BROWSER }}

    - name: Generate Reports
      run: |
        mkdir -p TestReports
        mv target/surefire-reports/testng-results.xml TestReports/
        mv target/surefire-reports/*.html TestReports/

    - name: Publish HTML Report
      uses: actions/upload-artifact@v3
      with:
        name: TestReports
        path: TestReports/
