name: Frost Test Automation Pipeline

on:
  workflow_dispatch:
    inputs:
      Branch:
        description: "Please enter the branch name"
        default: "main"
        required: true
      Select_Environment:
        description: "Select the Environment which you want to test"
        required: true
        type: choice
        options:
          - "https://frost-dev.health.elsevier.com/"
          - "https://frost-cert.health.elsevier.com/"
          - "https://frost-stage.health.elsevier.com/"
          - "https://frost-prod.health.elsevier.com/"
      Frost_Username:
        description: "Please enter the username"
        required: true
      Frost_Password:
        description: "Please enter the encrypted password"
        required: true
      Select_Browser:
        description: "Select the browser on which you want to run test"
        required: true
        type: choice
        options:
          - "Chrome"
          - "FireFox"
          - "Edge"
          - "Safari"
      Select_Group:
        description: "Select the test group/name you want to run"
        default: ""
        required: false
      Parallel_Execution:
        description: "Select 'Yes' if you want to run test cases in Parallel Mode"
        required: true
        type: choice
        options:
          - "Yes"
          - "No"
      Parallel_Execution_Mode:
        description: "Please select the Parallel Execution Mode. Must be 'NONE' if Parallel Execution is 'No'"
        default: "NONE"
        required: true
        type: choice
        options:
          - "CLASSES"
          - "METHODS"
          - "INSTANCES"
          - "TESTS"
          - "NONE"
      Parallel_Execution_Thread_Count:
        description: "Please select the Parallel Execution Thread Count. Recommended to limit to 3 if Parallel Execution is 'Yes'. Must be '1' if Parallel Execution is 'No'."
        default: "1"
        required: true
        type: choice
        options:
          - "1"
          - "2"
          - "3"
          - "4"
          - "5"

jobs:
  frost-pipeline:
    runs-on: ubuntu-latest

    env:
      APPLICATION_URL: ${{ inputs.Select_Environment }}
      FROST_USERNAME: ${{ inputs.Frost_Username }}
      FROST_PASSWORD: ${{ inputs.Frost_Password }}
      BROWSER: ${{ inputs.Select_Browser }}
      GROUPS: ${{ inputs.Select_Group }}
      PARALLEL_EXECUTION: ${{ inputs.Parallel_Execution }}
      PARALLEL_EXECUTION_MODE: ${{ inputs.Parallel_Execution_Mode }}
      PARALLEL_EXECUTION_THREAD_COUNT: ${{ inputs.Parallel_Execution_Thread_Count }}

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3
      with:
        ref: ${{ inputs.Branch }}

    - name: Set Up Java
      uses: actions/setup-java@v3
      with:
        java-version: 11
        distribution: adopt

    - name: Install Maven
      run: sudo apt-get install -y maven

    - name: Set Environment and Build
      run: |
        # Extract the environment name from the URL
        ENVIRONMENT_NAME=$(echo "${{ inputs.Select_Environment }}" | sed -E 's|https://frost-([a-z]+).health.elsevier.com/|\1|' | tr '[:lower:]' '[:upper:]')

        # Capture the start time
        START_TIME=$(date)

        # Log the environment details as a notice
        echo "::notice title=Environment Details::Environment: $ENVIRONMENT_NAME, URL: ${{ inputs.Select_Environment }}, Browser: ${{ inputs.Select_Browser }}"

        # Write environment details to the job summary
        echo "### Test Execution Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: $ENVIRONMENT_NAME" >> $GITHUB_STEP_SUMMARY
        echo "- **URL**: ${{ inputs.Select_Environment }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Browser**: ${{ inputs.Select_Browser }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Start Time**: $START_TIME" >> $GITHUB_STEP_SUMMARY

        # Simulate the build step
        echo "Building branch ${{ inputs.Branch }} in environment $ENVIRONMENT_NAME using browser ${{ inputs.Select_Browser }}"

        # Export the start time as an environment variable for later use
        echo "START_TIME=$START_TIME" >> $GITHUB_ENV

        # Compile Source Code
        mvn compile

    - name: Test Execution
      run: |
        mvn test \
          -Dapplication.url=${{ env.APPLICATION_URL }} \
          -Dusername=${{ env.FROST_USERNAME }} \
          -Dpassword=${{ env.FROST_PASSWORD }} \
          -Dbrowser=${{ env.BROWSER }} \
          -Dgroups=${{ env.GROUPS }} \
          -Dparallel.execution=${{ env.PARALLEL_EXECUTION }} \
          -Dparallel.execution.mode=${{ env.PARALLEL_EXECUTION_MODE }} \
          -Dparallel.execution.thread.count=${{ env.PARALLEL_EXECUTION_THREAD_COUNT }}
      continue-on-error: true # Allow the workflow to proceed even if this step fails

    - name: Generate Reports
      run: |
        mkdir -p TestReports
        mv target/surefire-reports/testng-results.xml TestReports/
        mv target/surefire-reports/*.html TestReports/

    - name: Publish HTML Report
      uses: actions/upload-artifact@v4 # Updated to the latest version
      with:
        name: TestReports
        path: TestReports/

    - name: Display TestNG Results in Logs
      run: |
        cat TestReports/testng-results.xml
        
        # Capture the end time
        END_TIME=$(date -u)

        # Append the end time to the job summary
        echo "- **End Time**: $END_TIME" >> $GITHUB_STEP_SUMMARY

        # Extract the test summary from the Maven output
        TEST_SUMMARY=$(grep -E "\[INFO\] Tests run:" maven-output.log | tail -1)

        # Append the test summary to the job summary
        echo "### Execution Report Summary" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "$TEST_SUMMARY" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
